<!DOCTYPE html>
<html class="fullscreen">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<link rel="icon" type="image/png" sizes="32x32" href="img/small-icon.png">
<link rel="shortcut icon" href="img/small-icon.png" type="image/png">
<link rel="apple-touch-icon" href="img/apple_icons_57x57.png">
<link rel="apple-touch-icon" sizes="72x72" href="img/apple_icons_72x72.png">
<link rel="apple-touch-icon" sizes="114x114" href="img/apple_icons_114x114.png">
<title>Code Ninjas Photo Gallery</title>
<link href="https://fonts.googleapis.com/css?family=Roboto:400,700,400italic" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=Muli" rel="stylesheet" type="text/css">
<link rel="stylesheet" href="css/theme.css" type="text/css" media="all" />
<link rel="stylesheet" href="css/responsive.css" type="text/css" media="all" />
<link rel="stylesheet" href="css/custom.css" type="text/css" media="all" />
</head>
<body>
	<header class="main_header">
    	<div class="header_scroll">
            <div class="header_wrapper">
            	<a href="index.html" class="logo"><img src="img/logo-white-outline.png" alt="" class="logo_def"><img src="img/logo-white-outline.png" alt="" class="logo_retina"></a>                
                <nav>
                	<div class="menu-main-menu-container">
                    	<ul id="menu-main-menu" class="menu">
                        	<li>
                            	<a href="index.html"><span>Home</span></a>                            
                            </li>
                            <li class="menu-item-has-children">
                            	<a href="albums.html"><span>Albums</span></a>
                                <ul class="sub-menu" id="albums-dropdown">
                                    <!-- Albums will be dynamically loaded here -->
                                </ul>
                            </li>
                        </ul>                    
                    </div>
                </nav>            
            </div><!-- Header Wrapper -->
            <div class="footer_wrapper">            
                <div class="socials_wrapper">
                    <ul class="socials_list">
                    	<li><a class="ico_social_facebook" target="_blank" href="https://www.facebook.com/CodeNinjasLibertyville/" title="Facebook"></a></li>
                        <li><a class="ico_social_instagram" target="_blank" href="https://www.instagram.com/codeninjas/?hl=en" title="Instagram"></a></li>
                        <li><a class="ico_social_codeninjas" target="_blank" href="https://www.codeninjas.com/" title="Code Ninjas"><img src="img/small-icon.png" alt="Code Ninjas"></a></li>
                    </ul>
                </div>
                <div class="copyright">Copyright &copy; Code Ninjas.<br>All Rights Reserved</div>
            </div><!-- footer_wrapper -->
    	</div>
	</header>
    
    <div class="fullscreen_block hided" style="display: none;">
        <div class="fs_blog_module fw_port_module2 hidden mt7 ml7 sorting_block">
        	<div class="blogpost_preview_fw fw-portPreview element nature pr7 pb7">
            	<div class="fw-portPreview-wrapper featured_items">
                    <div class="img_block wrapped_img">
                        <a class="featured_ico_link" href="portfolio_simple_fullwidth_image_post.html">
                            <img alt="" width="540" src="img/portfolio/grid/1.jpg" />
                            <div class="featured_item_fadder"></div>
                        </a>
                        <div class="gallery_likes gallery_likes_add already_liked">
                            <i class="stand_icon icon-heart"></i>
                            <span>224</span>
                        </div>
                    </div>                    
                </div>
            </div>      
            <div class="blogpost_preview_fw fw-portPreview element fashion portrait pr7 pb7">
            	<div class="fw-portPreview-wrapper featured_items">
                    <div class="img_block wrapped_img">
                        <a class="featured_ico_link" href="portfolio_simple_fullwidth_image_post.html">
                            <img alt="" width="540" src="img/portfolio/grid/2.jpg" />
                            <div class="featured_item_fadder"></div>
                        </a>
                        <div class="gallery_likes gallery_likes_add">
                            <i class="stand_icon icon-heart-o"></i>
                            <span>278</span>
                        </div>
                    </div>                    
                </div>
            </div>
            <div class="blogpost_preview_fw fw-portPreview element cities nature pr7 pb7">
            	<div class="fw-portPreview-wrapper featured_items">
                    <div class="img_block wrapped_img">
                        <a class="featured_ico_link" href="portfolio_simple_fullwidth_image_post.html">
                            <img alt="" width="540" src="img/portfolio/grid/3.jpg" />
                            <div class="featured_item_fadder"></div>
                        </a>
                        <div class="gallery_likes gallery_likes_add">
                            <i class="stand_icon icon-heart-o"></i>
                            <span>135</span>
                        </div>
                    </div>                    
                </div>
            </div> 
            <div class="blogpost_preview_fw fw-portPreview element advertisement nature pr7 pb7">
            	<div class="fw-portPreview-wrapper featured_items">
                    <div class="img_block wrapped_img">
                        <a class="featured_ico_link" href="portfolio_simple_fullwidth_image_post.html">
                            <img alt="" width="540" src="img/portfolio/grid/4.jpg" />
                            <div class="featured_item_fadder"></div>
                        </a>
                        <div class="gallery_likes gallery_likes_add">
                            <i class="stand_icon icon-heart-o"></i>
                            <span>61</span>
                        </div>
                    </div>                    
                </div>
            </div>
            <div class="blogpost_preview_fw fw-portPreview element advertisement nature pr7 pb7">
            	<div class="fw-portPreview-wrapper featured_items">
                    <div class="img_block wrapped_img">
                        <a class="featured_ico_link" href="portfolio_simple_fullwidth_image_post.html">
                            <img alt="" width="540" src="img/portfolio/grid/5.jpg" />
                            <div class="featured_item_fadder"></div>
                        </a>
                        <div class="gallery_likes gallery_likes_add already_liked">
                            <i class="stand_icon icon-heart"></i>
                            <span>115</span>
                        </div>
                    </div>                    
                </div>
            </div>
            <div class="blogpost_preview_fw fw-portPreview element cities stuff pr7 pb7">
            	<div class="fw-portPreview-wrapper featured_items">
                    <div class="img_block wrapped_img">
                        <a class="featured_ico_link" href="portfolio_simple_fullwidth_image_post.html">
                            <img alt="" width="540" src="img/portfolio/grid/6.jpg" />
                            <div class="featured_item_fadder"></div>
                        </a>
                        <div class="gallery_likes gallery_likes_add">
                            <i class="stand_icon icon-heart-o"></i>
                            <span>91</span>
                        </div>
                    </div>                    
                </div>
            </div>
            <div class="blogpost_preview_fw fw-portPreview element fashion portrait pr7 pb7">
            	<div class="fw-portPreview-wrapper featured_items">
                    <div class="img_block wrapped_img">
                        <a class="featured_ico_link" href="portfolio_simple_fullwidth_image_post.html">
                            <img alt="" width="540" src="img/portfolio/grid/7.jpg" />
                            <div class="featured_item_fadder"></div>
                        </a>
                        <div class="gallery_likes gallery_likes_add">
                            <i class="stand_icon icon-heart-o"></i>
                            <span>102</span>
                        </div>
                    </div>                    
                </div>
            </div>
            <div class="blogpost_preview_fw fw-portPreview element advertisement nature pr7 pb7">
            	<div class="fw-portPreview-wrapper featured_items">
                    <div class="img_block wrapped_img">
                        <a class="featured_ico_link" href="portfolio_simple_fullwidth_image_post.html">
                            <img alt="" width="540" src="img/portfolio/grid/8.jpg" />
                            <div class="featured_item_fadder"></div>
                        </a>
                        <div class="gallery_likes gallery_likes_add">
                            <i class="stand_icon icon-heart-o"></i>
                            <span>54</span>
                        </div>
                    </div>                    
                </div>
            </div>
            <div class="blogpost_preview_fw fw-portPreview element nature stuff pr7 pb7">
            	<div class="fw-portPreview-wrapper featured_items">
                    <div class="img_block wrapped_img">
                        <a class="featured_ico_link" href="portfolio_simple_fullwidth_image_post.html">
                            <img alt="" width="540" src="img/portfolio/grid/9.jpg" />
                            <div class="featured_item_fadder"></div>
                        </a>
                        <div class="gallery_likes gallery_likes_add already_liked">
                            <i class="stand_icon icon-heart"></i>
                            <span>41</span>
                        </div>
                    </div>                    
                </div>
            </div>
            <div class="blogpost_preview_fw fw-portPreview element nature pr7 pb7">
            	<div class="fw-portPreview-wrapper featured_items">
                    <div class="img_block wrapped_img">
                        <a class="featured_ico_link" href="portfolio_simple_fullwidth_image_post.html">
                            <img alt="" width="540" src="img/portfolio/grid/10.jpg" />
                            <div class="featured_item_fadder"></div>
                        </a>
                        <div class="gallery_likes gallery_likes_add">
                            <i class="stand_icon icon-heart-o"></i>
                            <span>22</span>
                        </div>
                    </div>                    
                </div>
            </div>
            <div class="blogpost_preview_fw fw-portPreview element advertisement cities stuff pr7 pb7">
            	<div class="fw-portPreview-wrapper featured_items">
                    <div class="img_block wrapped_img">
                        <a class="featured_ico_link" href="portfolio_simple_fullwidth_image_post.html">
                            <img alt="" width="540" src="img/portfolio/grid/11.jpg" />
                            <div class="featured_item_fadder"></div>
                        </a>
                        <div class="gallery_likes gallery_likes_add">
                            <i class="stand_icon icon-heart-o"></i>
                            <span>32</span>
                        </div>
                    </div>                    
                </div>
            </div>
            <div class="blogpost_preview_fw fw-portPreview element fashion portrait pr7 pb7">
            	<div class="fw-portPreview-wrapper featured_items">
                    <div class="img_block wrapped_img">
                        <a class="featured_ico_link" href="portfolio_simple_fullwidth_image_post.html">
                            <img alt="" width="540" src="img/portfolio/grid/12.jpg" />
                            <div class="featured_item_fadder"></div>
                        </a>
                        <div class="gallery_likes gallery_likes_add">
                            <i class="stand_icon icon-heart-o"></i>
                            <span>52</span>
                        </div>
                    </div>                    
                </div>
            </div>
            <div class="blogpost_preview_fw fw-portPreview element advertisement nature stuff pr7 pb7">
            	<div class="fw-portPreview-wrapper featured_items">
                    <div class="img_block wrapped_img">
                        <a class="featured_ico_link" href="portfolio_simple_fullwidth_image_post.html">
                            <img alt="" width="540" src="img/portfolio/grid/13.jpg" />
                            <div class="featured_item_fadder"></div>
                        </a>
                        <div class="gallery_likes gallery_likes_add">
                            <i class="stand_icon icon-heart-o"></i>
                            <span>17</span>
                        </div>
                    </div>                    
                </div>
            </div>
            <div class="blogpost_preview_fw fw-portPreview element cities stuff pr7 pb7">
            	<div class="fw-portPreview-wrapper featured_items">
                    <div class="img_block wrapped_img">
                        <a class="featured_ico_link" href="portfolio_simple_fullwidth_image_post.html">
                            <img alt="" width="540" src="img/portfolio/grid/14.jpg" />
                            <div class="featured_item_fadder"></div>
                        </a>
                        <div class="gallery_likes gallery_likes_add">
                            <i class="stand_icon icon-heart-o"></i>
                            <span>21</span>
                        </div>
                    </div>                    
                </div>
            </div>
            <div class="blogpost_preview_fw fw-portPreview element advertisement nature pr7 pb7">
            	<div class="fw-portPreview-wrapper featured_items">
                    <div class="img_block wrapped_img">
                        <a class="featured_ico_link" href="portfolio_simple_fullwidth_image_post.html">
                            <img alt="" width="540" src="img/portfolio/grid/15.jpg" />
                            <div class="featured_item_fadder"></div>
                        </a>
                        <div class="gallery_likes gallery_likes_add">
                            <i class="stand_icon icon-heart-o"></i>
                            <span>38</span>
                        </div>
                    </div>                    
                </div>
            </div>
            <div class="blogpost_preview_fw fw-portPreview element fashion portrait pr7 pb7">
            	<div class="fw-portPreview-wrapper featured_items">
                    <div class="img_block wrapped_img">
                        <a class="featured_ico_link" href="portfolio_simple_fullwidth_image_post.html">
                            <img alt="" width="540" src="img/portfolio/grid/16.jpg" />
                            <div class="featured_item_fadder"></div>
                        </a>
                        <div class="gallery_likes gallery_likes_add">
                            <i class="stand_icon icon-heart-o"></i>
                            <span>37</span>
                        </div>
                    </div>                    
                </div>
            </div>      
		</div>
	</div> 
    <div class="custom_bg img_bg def_bg"></div>
    <div id="mediaModal" class="modalOverlay">
        <span id="closeModal" class="modalClose">&times;</span>
        <button id="modalPrev" class="modal-arrow left">&#x2039;</button>
        <button id="modalNext" class="modal-arrow right">&#x203a;</button>
        <img id="modalImage" class="modal" style="display:none;"/>
        <video id="modalVideo" class="modal" style="display:none;" controls autoplay></video>
    </div>
    <script type="text/javascript" src="js/jquery.min.js"></script>
	<script type="text/javascript" src="js/jquery-ui.min.js"></script>    
    <script type="text/javascript" src="js/modules.js"></script>
	<script type="text/javascript" src="js/theme.js"></script>
    <script>
    	// Fetch data from Airtable via PHP proxy (FastComet hosting)
        // This keeps API keys secure on the server side
        function showLoadingSkeleton($grid) {
            // Create 12 skeleton loader boxes
            for (var i = 0; i < 12; i++) {
                var skeletonHtml = 
                    '<div class="blogpost_preview_fw fw-portPreview element nature pr7 pb7 skeleton-loader">' +
                        '<div class="fw-portPreview-wrapper featured_items">' +
                            '<div class="img_block wrapped_img">' +
                                '<div class="skeleton-box"></div>' +
                            '</div>' +
                        '</div>' +
                    '</div>';
                $grid.append(skeletonHtml);
            }
        }

        window.addEventListener('DOMContentLoaded', function() {
            // Lock header scroll position to prevent shifting during load
            var $headerScroll = jQuery('.header_scroll');
            var savedScrollTop = null;
            if ($headerScroll.length && $headerScroll.data('jsp')) {
                savedScrollTop = $headerScroll.data('jsp').getContentPositionY();
            }
            
            var urlParams = new URLSearchParams(window.location.search);
            var albumID = urlParams.get('album');
            console.log('Album ID from URL:', albumID);
            
            // Hide existing template content and show loading skeleton
            var $fullscreenBlock = jQuery('.fullscreen_block');
            var $grid = jQuery('.fs_blog_module');
            
            // Show the fullscreen block and grid immediately (they're hidden by CSS)
            $fullscreenBlock.css({display: 'block', opacity: '0', visibility: 'visible'});
            $grid.empty();
            showLoadingSkeleton($grid);
            
            // Fade in the skeleton
            setTimeout(function() {
                $fullscreenBlock.css('opacity', '1');
                // Restore scroll position if it was saved
                if (savedScrollTop !== null && $headerScroll.length && $headerScroll.data('jsp')) {
                    $headerScroll.data('jsp').scrollToY(savedScrollTop, false);
                }
            }, 50);
            
            // Use PHP endpoint (works on FastComet and most shared hosting)
            const apiUrl = './api/airtable.php';
            
            // Fetch data from our secure proxy
            fetch(apiUrl)
            .then(res => {
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                console.log('Airtable HTTP status:', res.status);
                return res.json();
            })
    .then(data => {
        console.log('Airtable data:', data);

        function buildGallery(data, albumID)
        {
            var $fullscreenBlock = jQuery('.fullscreen_block');
            var $grid = jQuery('.fs_blog_module');
            $grid.empty();
            
            // Ensure grid is visible
            $fullscreenBlock.css({display: 'block', opacity: '1', visibility: 'visible'});
            $grid.removeClass('hided hidden').show();

            if(!data || !data.records || !Array.isArray(data.records))
            {
                console.error('no records found in data');
                return;
            }

            // Pagination settings
            var pageSize = 12; // items per page
            var currentPage = 1;
            var filtered = [];

            // Build a normalized list of media items to render (preserve order)
            for(var i=0; i<data.records.length; i++) {
                var record = data.records[i];
                if (record.fields.Published !== true) continue;

                if (albumID) {
                    var photoAlbums = record.fields.Albums || [];
                    var belongsToAlbum = false;
                    if (Array.isArray(photoAlbums)) {
                        for (var j = 0; j < photoAlbums.length; j++) {
                            // Compare as strings to handle any type mismatches
                            if (String(photoAlbums[j]) === String(albumID)) { 
                                belongsToAlbum = true; 
                                break; 
                            }
                        }
                    }
                    if (!belongsToAlbum) continue;
                }

                var type = record.fields.Type || '';
                var typeStr = String(type).toLowerCase();
                var isPhoto = (typeStr === 'photo');
                var isVideo = (typeStr === 'video');
                var isLink = (typeStr === 'link');
                var isMediaType = isPhoto || isVideo;

                // Get photo attachments
                var photoAttachments = record.fields && record.fields.Photo || [];
                var photoAtt = photoAttachments[0] || {};
                var hasPhoto = !!(photoAtt.url || (photoAtt.thumbnails && photoAtt.thumbnails.large && photoAtt.thumbnails.large.url));

                // Get video attachments
                var videoAttachments = record.fields && record.fields.Video || [];
                var videoAtt = videoAttachments[0] || {};
                var hasVideo = !!(videoAtt.url);

                // Thumbnail/image URL logic
                var imageUrl = '';
                if (hasPhoto) {
                    // Use photo thumbnail/url when available
                    if (photoAtt.thumbnails && photoAtt.thumbnails.large && photoAtt.thumbnails.large.url) {
                        imageUrl = photoAtt.thumbnails.large.url;
                    } else if (photoAtt.url) {
                        imageUrl = photoAtt.url;
                    }
                } else if ((isLink || isVideo) && hasVideo) {
                    // For link or video type with no photo but has video, use video thumbnail as cover if available
                    // Otherwise, first frame will be extracted dynamically during rendering
                    if (videoAtt.thumbnails && videoAtt.thumbnails.large && videoAtt.thumbnails.large.url) {
                        imageUrl = videoAtt.thumbnails.large.url;
                    }
                    // If no thumbnail, imageUrl remains empty and first frame will be extracted
                }

                // Video URL
                var videoUrl = '';
                if (hasVideo) {
                    videoUrl = videoAtt.url;
                }

                // Link handling
                var linkValue = '#';
                if (isLink) {
                    linkValue = record.fields.Link || '#';
                    if (linkValue && linkValue !== '#' && !linkValue.startsWith('http://') && !linkValue.startsWith('https://')) {
                        linkValue = 'http://' + linkValue;
                    }
                }

                // Get Title field
                var title = record.fields.Title || '';

                // Push normalized item
                filtered.push({
                    record: record,
                    imageUrl: imageUrl,
                    videoUrl: videoUrl,
                    type: typeStr,
                    link: (isMediaType ? '#' : linkValue),
                    hasPhoto: hasPhoto,
                    hasVideo: hasVideo,
                    title: title
                });
            }

            console.log('Filtered items count:', filtered.length);
            console.log('Album ID:', albumID);
            
            if (filtered.length === 0) {
                console.warn('No items found after filtering. Total records:', data.records.length);
                $grid.empty();
                $grid.append('<div style="padding: 40px; text-align: center; color: #666;">No media found.</div>');
                return;
            }

            var totalPages = Math.max(1, Math.ceil(filtered.length / pageSize));

            // Expose the normalized list for modal navigation
            window.galleryItems = filtered;
            window.currentGalleryIndex = 0;

            // Page-level arrows removed — navigation is available inside modal preview now.

            // Helper function to extract first frame from video and crop to square (1:1) aspect ratio
            function extractVideoFirstFrame(videoUrl, callback) {
                var video = document.createElement('video');
                video.crossOrigin = 'anonymous';
                video.preload = 'metadata';
                video.muted = true; // Mute to allow autoplay in some browsers
                var timeoutId = null;
                var hasCalledBack = false;
                
                function cleanup() {
                    if (timeoutId) clearTimeout(timeoutId);
                    video.removeEventListener('loadedmetadata', onLoadedMetadata);
                    video.removeEventListener('seeked', onSeeked);
                    video.removeEventListener('error', onError);
                    video.src = '';
                }
                
                function onLoadedMetadata() {
                    try {
                        video.currentTime = 0.1; // Seek to first frame (0.1s to ensure frame is loaded)
                    } catch (e) {
                        if (!hasCalledBack) {
                            hasCalledBack = true;
                            cleanup();
                            callback(null);
                        }
                    }
                }
                
                function onSeeked() {
                    if (hasCalledBack) return;
                    try {
                        var videoWidth = video.videoWidth;
                        var videoHeight = video.videoHeight;
                        
                        if (videoWidth > 0 && videoHeight > 0) {
                            // Calculate square crop dimensions (1:1 aspect ratio)
                            var size = Math.min(videoWidth, videoHeight);
                            var sourceX = (videoWidth - size) / 2;
                            var sourceY = (videoHeight - size) / 2;
                            
                            // Create square canvas
                            var canvas = document.createElement('canvas');
                            canvas.width = size;
                            canvas.height = size;
                            var ctx = canvas.getContext('2d');
                            
                            // Draw cropped square portion of video frame
                            ctx.drawImage(video, sourceX, sourceY, size, size, 0, 0, size, size);
                            var dataUrl = canvas.toDataURL('image/jpeg', 0.8);
                            hasCalledBack = true;
                            cleanup();
                            callback(dataUrl);
                        } else {
                            if (!hasCalledBack) {
                                hasCalledBack = true;
                                cleanup();
                                callback(null);
                            }
                        }
                    } catch (e) {
                        console.error('Error extracting video frame:', e);
                        if (!hasCalledBack) {
                            hasCalledBack = true;
                            cleanup();
                            callback(null);
                        }
                    }
                }
                
                function onError() {
                    if (!hasCalledBack) {
                        hasCalledBack = true;
                        cleanup();
                        callback(null);
                    }
                }
                
                video.addEventListener('loadedmetadata', onLoadedMetadata);
                video.addEventListener('seeked', onSeeked);
                video.addEventListener('error', onError);
                
                // Set timeout (10 seconds)
                timeoutId = setTimeout(function() {
                    if (!hasCalledBack) {
                        hasCalledBack = true;
                        cleanup();
                        callback(null);
                    }
                }, 10000);
                
                video.src = videoUrl;
            }

            function renderPage(page) {
                currentPage = Math.max(1, Math.min(totalPages, page));
                $grid.empty();
                
                // Ensure grid and parent container are visible
                $grid.removeClass('hided hidden').show();
                jQuery('.fullscreen_block').removeClass('hided').show();

                var start = (currentPage - 1) * pageSize;
                var end = Math.min(filtered.length, start + pageSize);

                for (var k = start; k < end; k++) {
                    var item = filtered[k];
                    if (!item) continue;
                    
                    var titleText = item.title || '';
                    // Ensure we have an imageUrl or placeholder
                    var imgSrc = item.imageUrl || 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';
                    
                    var htmlItem =
                        '<div class="blogpost_preview_fw fw-portPreview element nature pr7 pb7">' +
                            '<div class="fw-portPreview-wrapper featured_items">' +
                                '<div class="img_block wrapped_img">' +
                                    '<a class="featured_ico_link" href="#" data-media-type="' + item.type + '" data-index="' + k + '">' +
                                        '<img alt="" width="540" src="' + imgSrc + '" data-item-index="' + k + '" />' +
                                        '<div class="featured_item_fadder"></div>' +
                                        '<div class="media-gradient-overlay"></div>' +
                                        (titleText ? '<div class="media-title-text">' + titleText + '</div>' : '') +
                                    '</a>' +
                                '</div>' +
                            '</div>' +
                        '</div>';

                    var $item = jQuery(htmlItem);
                    $grid.append($item);
                    
                    // For link or video items with video but no photo, extract first frame
                    if ((item.type === 'link' || item.type === 'video') && !item.hasPhoto && item.hasVideo && item.videoUrl) {
                        var $img = $item.find('img');
                        // Set a placeholder or empty src initially
                        if (!item.imageUrl) {
                            $img.attr('src', 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'); // 1x1 transparent pixel
                        }
                        // Try to extract first frame from video (cropped to square)
                        extractVideoFirstFrame(item.videoUrl, function(frameDataUrl) {
                            if (frameDataUrl) {
                                $img.attr('src', frameDataUrl);
                                // Update the item's imageUrl for modal use
                                if (window.galleryItems && window.galleryItems[k]) {
                                    window.galleryItems[k].imageUrl = frameDataUrl;
                                }
                            } else if (!item.imageUrl) {
                                // If extraction fails and no thumbnail, use video URL as fallback
                                $img.attr('src', item.videoUrl);
                            }
                        });
                    }

                    // Attach handlers for all items (photo, video, and link)
                    $item.find('a.featured_ico_link').on('click', function(e){
                        e.preventDefault();
                        var idx = parseInt(jQuery(this).attr('data-index'), 10);
                        window.currentGalleryIndex = idx;
                        // Use modal helper (defined later) to display item by index
                        if (typeof window.showMediaFromIndex === 'function') {
                            window.showMediaFromIndex(idx);
                        } else {
                            // fallback: open modal with this item's media
                            var $modal = jQuery('#mediaModal');
                            var $modalImg = jQuery('#modalImage');
                            var $modalVid = jQuery('#modalVideo');
                            $modalImg.hide().attr('src', '');
                            $modalVid.hide().attr('src', '');
                            
                            if (item.type === 'photo') {
                                $modalImg.attr('src', item.imageUrl).show();
                            } else if (item.type === 'video') {
                                $modalVid.attr('src', item.videoUrl).show();
                                try { $modalVid.get(0).play(); } catch(e){}
                            } else if (item.type === 'link') {
                                // For link items: show video if available, otherwise show image
                                if (item.hasVideo && item.videoUrl) {
                                    $modalVid.attr('src', item.videoUrl).show();
                                    try { $modalVid.get(0).play(); } catch(e){}
                                } else if (item.imageUrl) {
                                    $modalImg.attr('src', item.imageUrl).show();
                                }
                            }
                            $modal.addClass('open');
                        }
                    });
                }

                // (page-level arrow UI removed)
            }

            // Page-level arrow handlers removed — modal preview handles previous/next.

            // Initial render
            renderPage(1);
            
            // Restore scroll position after content loads
            if (savedScrollTop !== null && $headerScroll.length && $headerScroll.data('jsp')) {
                setTimeout(function() {
                    $headerScroll.data('jsp').scrollToY(savedScrollTop, false);
                }, 100);
            }
        }
        
        buildGallery(data, albumID);
    })
    .catch(error => {
        console.error('Airtable fetch error:', error);
    });
});

        jQuery(document).ready(function ($) {
			"use strict";
			
			// Lock header scroll position during loading to prevent shifting
			var $headerScroll = jQuery('.header_scroll');
			var savedScrollTop = 0;
			if ($headerScroll.length && $headerScroll.data('jsp')) {
				savedScrollTop = $headerScroll.data('jsp').getContentPositionY();
			}
			
			jQuery('.custom_bg').remove();
			
			// Restore scroll position after a brief delay to prevent shifting
			setTimeout(function() {
				if ($headerScroll.length && $headerScroll.data('jsp')) {
					$headerScroll.data('jsp').scrollToY(savedScrollTop, false);
				}
			}, 100);
		});       				
	</script>
    <script>
        // Load albums dynamically into dropdown menu
        (function() {
            const apiUrl = './api/airtable.php?table=albums';
            fetch(apiUrl)
                .then(res => {
                    if (!res.ok) {
                        throw new Error(`HTTP error! status: ${res.status}`);
                    }
                    return res.json();
                })
                .then(data => {
                    if (data && data.records && Array.isArray(data.records)) {
                        // Build dropdown menu items from albums
                        var $dropdown = jQuery('#albums-dropdown');
                        if ($dropdown.length) {
                            $dropdown.empty();
                            
                            // Add all albums
                            for (var i = 0; i < data.records.length; i++) {
                                var record = data.records[i];
                                if (record.fields.Published !== true) continue;
                                
                                var albumID = record.id || '';
                                var albumName = record.fields.Title || 'Untitled Album';
                                var $li = jQuery('<li><a href="photo_grid.html?album=' + encodeURIComponent(albumID) + '"><span>' + albumName + '</span></a></li>');
                                $dropdown.append($li);
                            }
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading albums for dropdown:', error);
                });
        })();
    </script>
    <script>
        // Handle click on Albums arrow to toggle dropdown
        jQuery(document).ready(function($) {
            $('.main_header nav ul.menu > li.menu-item-has-children > a').on('click', function(e) {
                var $link = $(this);
                var $parent = $link.parent('li');
                var linkOffset = $link.offset();
                var linkWidth = $link.outerWidth();
                var clickX = e.pageX - linkOffset.left;
                
                // If click is in the arrow area (right 20px), toggle dropdown
                if (clickX > linkWidth - 20) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Toggle active class
                    $parent.toggleClass('active');
                    
                    // Close other dropdowns
                    $('.main_header nav ul.menu > li.menu-item-has-children').not($parent).removeClass('active');
                }
                // Otherwise, allow normal link navigation to albums.html
            });
            
            // Close dropdown when clicking outside
            $(document).on('click', function(e) {
                if (!$(e.target).closest('.main_header nav ul.menu > li.menu-item-has-children').length) {
                    $('.main_header nav ul.menu > li.menu-item-has-children').removeClass('active');
                }
            });
        });
    </script>
    <script>
        // Modal close handlers (separate script placed after main gallery code)
        (function(){
            var $modal = jQuery('#mediaModal');
            var $modalImg = jQuery('#modalImage');
            var $modalVid = jQuery('#modalVideo');
            var $close = jQuery('#closeModal');
            var $prev = jQuery('#modalPrev');
            var $next = jQuery('#modalNext');

            function closeModal() {
                $modal.removeClass('open');
                $modalImg.attr('src', '').hide();
                try { $modalVid.get(0).pause(); } catch(e){}
                $modalVid.attr('src', '').hide();
            }

            function showMediaFromIndex(idx) {
                var list = window.galleryItems || [];
                if (!Array.isArray(list) || !list[idx]) return;
                var itm = list[idx];
                window.currentGalleryIndex = idx;
                $modalImg.hide().attr('src', '');
                try { $modalVid.get(0).pause(); } catch(e){}
                $modalVid.hide().attr('src', '');
                // Clear link attributes from both image and video
                $modalImg.removeClass('link-preview').removeAttr('data-link-url').css('cursor', '');
                $modalVid.removeClass('link-preview').removeAttr('data-link-url');

                if (itm.type === 'photo') {
                    $modalImg.attr('src', itm.imageUrl).show();
                } else if (itm.type === 'video') {
                    $modalVid.attr('src', itm.videoUrl).show();
                    try { $modalVid.get(0).play(); } catch(e){}
                } else if (itm.type === 'link') {
                    var targetUrl = itm.link || (itm.record && itm.record.fields && itm.record.fields.Link) || null;
                    // If link has video, show video in modal; otherwise show image
                    if (itm.hasVideo && itm.videoUrl) {
                        $modalVid.attr('src', itm.videoUrl).addClass('link-preview');
                        if (targetUrl && targetUrl !== '#') {
                            $modalVid.attr('data-link-url', targetUrl);
                        }
                        $modalVid.show();
                        try { $modalVid.get(0).play(); } catch(e){}
                    } else if (itm.imageUrl) {
                        // Show cover image if no video or video not available
                        $modalImg.attr('src', itm.imageUrl).addClass('link-preview');
                        if (targetUrl && targetUrl !== '#') {
                            $modalImg.attr('data-link-url', targetUrl).css('cursor', 'pointer');
                        }
                        $modalImg.show();
                    }
                }
                $modal.addClass('open');
                // update prev/next disabled states
                $prev.prop('disabled', idx <= 0).toggleClass('disabled', idx <= 0);
                $next.prop('disabled', idx >= (list.length - 1)).toggleClass('disabled', idx >= (list.length - 1));
            }

            window.showMediaFromIndex = showMediaFromIndex;

            $close.on('click', function(e){
                e.preventDefault();
                closeModal();
            });

            $prev.on('click', function(e){
                e.preventDefault();
                var idx = (typeof window.currentGalleryIndex === 'number') ? window.currentGalleryIndex - 1 : -1;
                if (idx >= 0) showMediaFromIndex(idx);
            });

            $next.on('click', function(e){
                e.preventDefault();
                var list = window.galleryItems || [];
                var idx = (typeof window.currentGalleryIndex === 'number') ? window.currentGalleryIndex + 1 : 0;
                if (idx < list.length) showMediaFromIndex(idx);
            });

            // Click handler for link preview images - clicking opens the link
            $modalImg.on('click', function(e){
                if (jQuery(this).hasClass('link-preview')) {
                    var linkUrl = jQuery(this).attr('data-link-url');
                    if (linkUrl) {
                        e.stopPropagation(); // Prevent modal close
                        try { window.open(linkUrl, '_blank'); } catch(e) { window.location.href = linkUrl; }
                    }
                }
            });

            // Click handler for link preview videos - double-click opens the link
            // Using double-click to avoid interfering with video controls (play/pause, etc.)
            $modalVid.on('dblclick', function(e){
                if (jQuery(this).hasClass('link-preview')) {
                    var linkUrl = jQuery(this).attr('data-link-url');
                    if (linkUrl) {
                        e.stopPropagation();
                        e.preventDefault();
                        try { window.open(linkUrl, '_blank'); } catch(err) { window.location.href = linkUrl; }
                    }
                }
            });

            // Clicking the overlay (but not the media) closes the modal
            $modal.on('click', function(e){
                if (e.target === this) {
                    closeModal();
                }
            });

            // Esc key closes modal; left/right navigate
            jQuery(document).on('keydown', function(e){
                if (e.key === 'Escape' || e.keyCode === 27) {
                    if ($modal.hasClass('open')) closeModal();
                    return;
                }
                if (!$modal.hasClass('open')) return;
                if (e.key === 'ArrowLeft' || e.keyCode === 37) {
                    var prevIdx = (typeof window.currentGalleryIndex === 'number') ? window.currentGalleryIndex - 1 : -1;
                    if (prevIdx >= 0) showMediaFromIndex(prevIdx);
                } else if (e.key === 'ArrowRight' || e.keyCode === 39) {
                    var nextIdx = (typeof window.currentGalleryIndex === 'number') ? window.currentGalleryIndex + 1 : 0;
                    var list2 = window.galleryItems || [];
                    if (nextIdx < list2.length) showMediaFromIndex(nextIdx);
                }
            });
        })();
    </script>
    <script type="text/javascript" src="js/jquery.isotope.min.js"></script>
</body>
</html>